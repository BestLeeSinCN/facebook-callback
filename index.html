<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook 授权中</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #1877f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }
        h2 {
            color: #1c1e21;
            margin: 0 0 10px;
            font-size: 24px;
        }
        .status {
            color: #65676b;
            margin: 10px 0;
            font-size: 14px;
        }
        .spinner {
            margin: 30px auto;
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1877f2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #e74c3c;
            margin-top: 20px;
            padding: 15px;
            background: #fee;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">f</div>
        <h2>Facebook 授权</h2>
        <p class="status" id="status">正在初始化...</p>
        <div class="spinner" id="spinner"></div>
        <div class="error" id="error" style="display:none;"></div>
    </div>

    <script>
        // 从 URL 参数获取配置信息
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                appId: params.get('appId'),
                apiVersion: params.get('apiVersion') || 'v24.0',
                scope: params.get('scope') || 'public_profile,email',
                locale: params.get('locale') || 'zh_CN'
            };
        }

        const config = getUrlParams();

        // 验证必需参数
        if (!config.appId) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = '错误：缺少 Facebook App ID 参数';
            
            sendToFlutter({
                success: false,
                error: 'missing_app_id',
                message: '缺少必需的 appId 参数'
            });
            
            throw new Error('Missing required appId parameter');
        }

        console.log('Facebook 配置:', config);

        // 更新状态显示
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // 显示错误
        function showError(message) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = message;
        }

        // 向 Flutter 发送消息
        function sendToFlutter(data) {
            try {
                // Flutter WebView 通信方式
                if (window.flutter_inappwebview) {
                    // flutter_inappwebview 插件
                    window.flutter_inappwebview.callHandler('FacebookAuth', data);
                } else if (window.FlutterAuth) {
                    // webview_flutter 插件的 JavascriptChannel
                    window.FlutterAuth.postMessage(JSON.stringify(data));
                } else {
                    console.log('Flutter handler not found, data:', data);
                }
            } catch (e) {
                console.error('Error sending to Flutter:', e);
            }
        }

        // 处理登录响应
        function handleLoginResponse(response) {
            console.log('Login response:', response);
            
            if (response.status === 'connected') {
                updateStatus('授权成功，正在获取用户信息...');
                
                // 获取用户信息
                FB.api('/me', {fields: 'id,name,email,picture'}, function(userInfo) {
                    console.log('User info:', userInfo);
                    
                    const authData = {
                        success: true,
                        accessToken: response.authResponse.accessToken,
                        userID: response.authResponse.userID,
                        expiresIn: response.authResponse.expiresIn,
                        signedRequest: response.authResponse.signedRequest,
                        dataAccessExpirationTime: response.authResponse.data_access_expiration_time,
                        graphDomain: response.authResponse.graphDomain || 'facebook',
                        user: {
                            id: userInfo.id,
                            name: userInfo.name,
                            email: userInfo.email || '',
                            picture: userInfo.picture ? userInfo.picture.data.url : ''
                        }
                    };
                    
                    updateStatus('完成！正在返回...');
                    
                    // 发送数据到 Flutter
                    sendToFlutter(authData);
                    
                    // 延迟一下，确保消息发送成功
                    setTimeout(() => {
                        updateStatus('授权完成，请返回应用');
                    }, 500);
                });
                
            } else if (response.status === 'not_authorized') {
                showError('您需要授权应用才能继续');
                sendToFlutter({
                    success: false,
                    error: 'not_authorized',
                    message: '用户未授权应用'
                });
                
            } else {
                showError('登录已取消或失败');
                sendToFlutter({
                    success: false,
                    error: 'login_cancelled',
                    message: '用户取消登录'
                });
            }
        }

        // 初始化 Facebook SDK
        window.fbAsyncInit = function() {
            updateStatus('正在初始化 Facebook SDK...');
            
            FB.init({
                appId: config.appId,
                cookie: true,
                xfbml: true,
                version: config.apiVersion
            });

            updateStatus('正在检查登录状态...');

            // 先检查登录状态
            FB.getLoginStatus(function(response) {
                console.log('当前登录状态:', response.status);
                
                if (response.status === 'connected') {
                    // 已经登录且已授权，直接处理
                    handleLoginResponse(response);
                } else {
                    // 未登录或未授权，自动触发登录
                    updateStatus('正在打开登录窗口...');
                    
                    FB.login(function(loginResponse) {
                        handleLoginResponse(loginResponse);
                    }, {
                        scope: config.scope,
                        return_scopes: true,
                        auth_type: 'rerequest'
                    });
                }
            });
        };

        // 动态加载 Facebook SDK
        (function(d, s, id){
            updateStatus('正在加载 Facebook SDK...');
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = `https://connect.facebook.net/${config.locale}/sdk.js`;
            js.onerror = function() {
                showError('无法加载 Facebook SDK，请检查网络连接');
                sendToFlutter({
                    success: false,
                    error: 'sdk_load_failed',
                    message: 'Facebook SDK 加载失败'
                });
            };
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // 错误处理
        window.addEventListener('error', function(e) {
            console.error('Page error:', e);
            showError('发生错误: ' + e.message);
            sendToFlutter({
                success: false,
                error: 'page_error',
                message: e.message
            });
        });

        // 页面加载超时处理
        setTimeout(function() {
            if (document.getElementById('spinner').style.display !== 'none') {
                showError('加载超时，请检查网络连接');
                sendToFlutter({
                    success: false,
                    error: 'timeout',
                    message: '加载超时'
                });
            }
        }, 30000);
    </script>
</body>
</html>
