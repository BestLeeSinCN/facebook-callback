<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Facebook Login Redirect</title>
    <style>
        body {
            margin: 0;
            background: #f4f6f9;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #333;
        }
        .box {
            text-align: center;
        }
        .loading {
            border: 6px solid #ddd;
            border-top: 6px solid #4A90E2;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        .msg {
            font-size: 16px;
        }
    </style>

    <script>
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        const APP_ID = getQueryParam("appid");
        const CODE = getQueryParam("code");
        const ERROR = getQueryParam("error");
        const ERROR_DESC = getQueryParam("error_description");

        function sendToFlutter(type, data) {
            if (window.AppJS && window.AppJS.postMessage) {
                window.AppJS.postMessage(JSON.stringify({type, data}));
            }
        }

        window.onload = function () {
            const msgDiv = document.getElementById("msg");

            // 1. 授权失败
            if (ERROR) {
                msgDiv.innerHTML = "授权失败：" + decodeURIComponent(ERROR_DESC || ERROR);
                sendToFlutter("error", ERROR_DESC || ERROR);
                return;
            }

            // 2. 授权成功
            if (CODE) {
                msgDiv.innerHTML = "授权成功，返回中…";
                sendToFlutter("success", CODE);
                return;
            }

            // 3. 首次进入，开始授权
            if (!APP_ID) {
                msgDiv.innerHTML = "缺少 appid 参数";
                sendToFlutter("error", "missing_appid");
                return;
            }

            msgDiv.innerHTML = "跳转 Facebook 授权中…";

            const redirectUri = encodeURIComponent("https://bestleesincn.github.io/facebook-callback/");
            const oauthUrl =
                `https://www.facebook.com/v19.0/dialog/oauth` +
                `?client_id=${APP_ID}` +
                `&redirect_uri=${redirectUri}` +
                `&response_type=code` +
                `&scope=public_profile,email`;

            setTimeout(() => {
                window.location.href = oauthUrl;
            }, 500);
        };
    </script>
</head>
<body>
<div class="box">
    <div class="loading"></div>
    <div id="msg" class="msg">加载中…</div>
</div>
</body>
</html>
