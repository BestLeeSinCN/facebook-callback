<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facebook Callback</title>
</head>
<body>
<script>
  const clientId = "你的FacebookAppID"; // TODO: 替换
  const redirectUri = "https://bestleesincn.github.io/facebook-callback/";

  (function () {
    console.log("Callback page loaded");

    // ---- 1. 检查是否带有 access_token（Facebook 授权回跳） ----
    if (window.location.hash.includes("access_token")) {
      handleFacebookCallback();
      return;
    }

    // ---- 2. 如果没有 token，说明是 Flutter 第一次打开 → 跳 Facebook 授权 ----
    redirectToFacebookLogin();
  })();

  /**
   * 跳转到 Facebook 授权页面
   */
  function redirectToFacebookLogin() {
    const fbAuthUrl =
      `https://www.facebook.com/v19.0/dialog/oauth?` +
      `client_id=${clientId}` +
      `&redirect_uri=${encodeURIComponent(redirectUri)}` +
      `&response_type=token`;

    console.log("Redirecting to FB Login:", fbAuthUrl);
    window.location.href = fbAuthUrl;
  }

  /**
   * 处理 Facebook 回调
   * 将 token 发送到 Flutter 再关闭 WebView
   */
  function handleFacebookCallback() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);

    const accessToken = params.get("access_token");
    const expiresIn = params.get("expires_in");

    const msg = {
      success: !!accessToken,
      accessToken,
      expiresIn
    };

    console.log("Sending token to Flutter:", msg);
    sendToFlutter(msg);

    // 给 Flutter 一点时间处理
    setTimeout(() => {
      window.close();
    }, 500);
  }

  /**
   * 向 Flutter WebView 发送消息
   */
  function sendToFlutter(message) {
    try {
      // Android/iOS webview_flutter
      if (window.AuthChannel && window.AuthChannel.postMessage) {
        window.AuthChannel.postMessage(JSON.stringify(message));
        return;
      }

      // flutter_inappwebview
      if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler("AuthChannel", message);
        return;
      }

      console.warn("No Flutter JS channel found");
    } catch (err) {
      console.error("Send to Flutter failed:", err);
    }
  }
</script>
</body>
</html>
